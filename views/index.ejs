<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robolution Blog</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <script src="/js/script.js" defer></script>
  <script src="/js/mobile.js" defer></script>
  <style>
    body, main {
      background-color: #ffffff;
      background-image: none;
    }
    
    /* Dropdown styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }
  
    .dropdown-btn {
      cursor: pointer;
    }
  
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      top: 100%;
      left: 0;
    }
  
    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: left;
    }
  
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
  
    .dropdown-empty {
      padding: 12px 16px;
      color: #666;
      font-style: italic;
    }
  
    /* Collapsible styles */
    .collapsible {
      background-color: #00008b;
      color: white;
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      margin-bottom: 10px;
      position: relative;
      border-radius: 5px;
    }
  
    .active, .collapsible:hover {
      background-color: #00006b;
    }
  
    .arrow {
      position: absolute;
      right: 20px;
      transition: transform 0.3s ease;
    }
  
    .active .arrow {
      transform: rotate(180deg);
    }
  
    .content {
      padding: 0 18px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
  
    .content.visible {
      max-height: 5000px; /* Adjust based on expected max height */
    }
  
    /* Post card styles */
    .post-card {
      width: calc(33.333% - 20px);
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      margin-bottom: 20px;
    }
  
    .post-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      object-position: center;
    }
  
    .post-card h3 {
      padding: 15px;
      margin: 0;
      color: #00008b;
      font-size: 18px;
    }
  
    .post-card-content {
      padding: 0 15px 15px;
      color: #444;
    }
  
    .post-card-content p {
      margin: 10px 0;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
  
    .date-posted {
      font-size: 0.8em;
      color: #777;
      margin-top: 10px;
    }
  
    .post-actions {
      display: flex;
      justify-content: flex-end;
      padding: 0 15px 15px;
      gap: 10px;
    }
  
    .edit-btn, .delete-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
  
    .edit-btn {
      background: #2196F3;
      color: white;
    }
  
    .delete-btn {
      background: #f44336;
      color: white;
    }
  
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
    }
  
    .posts-header h2 {
      margin: 0;
      color: #00008b;
    }
  
    .posts-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
  
    .search-form input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 200px;
    }
  
    .sort-form {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  
    .sort-form select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: white;
    }
  
    .year-section {
      margin-bottom: 30px;
    }
  
    /* Mobile responsiveness */
    @media screen and (max-width: 992px) {
      .post-card {
        width: calc(50% - 15px);
      }
    }
  
    @media screen and (max-width: 768px) {
      .post-card {
        width: 100%;
      }
  
      .posts-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
  
      .posts-controls {
        flex-direction: column;
        width: 100%;
      }
  
      .search-form, .sort-form, .search-form input {
        width: 100%;
      }
    }
  </style>
  
  <% if (locals.dashboard) { %>
  <style>
    /* Dashboard specific styles */
    body {
      padding: 0;
      margin: 0;
    }
    
    .content-wrapper {
      padding-top: 0;
    }
    
    /* Hide elements when in dashboard */
    header, footer, .video-section, .back-to-top {
      display: none !important;
    }
    
    main {
      padding-top: 20px !important;
    }
  </style>
  <% } %>
</head>

<body>
<div class="content-wrapper">

  <% if (!locals.dashboard) { %>
  <header>
    <div class="header-content">
      <img src="/images/LOGO.webp" alt="Robolution Logo" class="logo">
      <!-- Mobile menu toggle will be added by JavaScript on small screens -->
      <nav class="header-nav">
        <a href="/create-post" class="nav-button create-post-button">Create Post</a>
        <a href="/index" class="nav-button">News</a>
        <a href="/categories" class="nav-button">Categories</a>
        <a href="/manage-categories" class="nav-button">Manage Categories</a>
        <a href="/manage-registrations" class="nav-button">Manage Registration</a>
        <a href="/manage-accounts" class="nav-button">Accounts</a>
        <a href="/admin/user-profiles" class="nav-button">User Profiles</a>
        <% if (user && user.role === 'superadmin') { %>
        <a href="/manage-backups" class="nav-button">Backups</a>
        <% } %>
        <div class="dropdown">
          <button class="nav-button dropdown-btn">Regional</button>
          <div class="dropdown-content">
            <a href="/admin-regional?region=All">All Regions</a>
            <% 
            // Try to get regions with posts
            let validRegions = [];
            
            // Extract regions from posts
            posts.forEach(post => {
              if (post.region && post.region !== 'All' && !validRegions.includes(post.region)) {
                validRegions.push(post.region);
              }
            });
            
            // Sort regions alphabetically
            validRegions.sort();
            
            // Display regions with posts
            if (validRegions.length > 0) {
              validRegions.forEach(function(region) { %>
                <a href="/admin-regional?region=<%= region %>"><%= region %></a>
              <% });
            } else { %>
              <div class="dropdown-empty">No regional posts available</div>
            <% } %>
          </div>
        </div>
        <a href="/logout" class="nav-button logout-button">Logout</a>
      </nav>
    </div>
  </header>

  <div class="video-section">
    <video src="/images/Robolution2025.mp4" loop muted autoplay playsinline></video>
  </div>
  <% } %>

  <main>

    <% if (!locals.dashboard) { %>
    <div class="NandU">
      <img src="/images/News and Updates.png" alt="News and Updates" class="NandU-banner">
    </div>
    <% } %>

    <div class="posts-header">
      <h2>Posts by Year</h2>
      <div class="posts-controls">
        <div class="search-form">
          <input type="text" id="searchInput" placeholder="Search by title" value="<%= typeof search !== 'undefined' ? search : '' %>">
        </div>
        <form method="GET" action="/index" class="sort-form">
          <label for="sort">Sort by:</label>
          <select name="sort" id="sort" onchange="this.form.submit()">
            <option value="desc" <%= sort === 'desc' ? 'selected' : '' %>>Newest to Oldest</option>
            <option value="asc" <%= sort === 'asc' ? 'selected' : '' %>>Oldest to Newest</option>
          </select>
        </form>
      </div>
    </div>

    <% let years = {}; %>
    <% posts.forEach(post => { %>
      <% const year = new Date(post.createdAt).getFullYear(); %>
      <% if (!years[year]) years[year] = []; %>
      <% years[year].push(post); %>
    <% }); %>

    <div id="noPostsMessage" style="display: none; text-align: center; padding: 20px; font-size: 18px; color: #555;">
      No posts found matching "<span id="searchTerm"></span>"
    </div>

    <% Object.keys(years).sort((a, b) => { %>
      <% return sort === 'asc' ? a - b : b - a; %>
    <% }).forEach(year => { %>
      <div class="year-section" data-year="<%= year %>">
        <button class="collapsible"><%= year %> <span class="arrow">▼</span></button>
        <div class="content" style="display: none;">
          <% years[year].forEach(post => { %>
            <div class="post-card" data-title="<%= post.title.toLowerCase() %>" data-author="<%= post.author.toLowerCase() %>">
              <img src="<%= post.imageUrl %>" alt="<%= post.title %>" class="post-img">
              <h3><%= post.title %></h3>
              <div class="post-card-content">
                <p><%= post.content %></p>
                <p><strong>Author:</strong> <%= post.author %></p>
                <p class="date-posted">Posted on: <%= new Date(post.createdAt).toLocaleString('en-PH', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  timeZone: 'Asia/Manila'
                }) %></p>
              </div>
              <div class="post-actions">
                <a href="/edit-post/<%= post._id %>" class="edit-btn">Edit</a>
                <form action="/delete-post/<%= post._id %>" method="POST" class="delete-form" onsubmit="return confirmDelete(event)">
                  <button type="submit" class="delete-btn">Delete</button>
                </form>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% }) %>

  </main>

  <% if (!locals.dashboard) { %>
  <footer>
    <div class="footer-content">
      <div class="footer-left">
        <p>Powered by Erovoutika</p>
      </div>

      <footer class="fixed-footer">
        <div class="footer-content">
          <div class="footer-left">
            <p>Powered by Erovoutika</p>
          </div>

          <div class="footer-right">
            <p>Unit 703, PARC HOUSE II, Epifanio de los Santos Ave, Makati, 1212 Metro Manila</p>
            <p><strong>Contact us via:</strong> 0974 423 1557 || erovoutika@gmail.com</p>
            <div class="social-icons">
              <a href="https://www.facebook.com/erovoutika" target="_blank" class="social-icon">f</a>
              <a href="https://www.erovoutika.ph" target="_blank" class="social-icon">↗</a>
              <a href="https://www.linkedin.com/company/erovoutika/" target="_blank" class="social-icon">in</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </footer>
  
  <a href="#" class="back-to-top" id="backToTop">↑</a>
  <% } %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle collapsible sections
    const collapsibles = document.querySelectorAll('.collapsible');
    
    // Add confirmation function for delete buttons
    window.confirmDelete = function(event) {
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        event.preventDefault();
        return false;
      }
      return true;
    };
    
    // Check authentication state on page load and especially when returning via back button
    function verifySession() {
      // Add a random parameter to avoid caching
      fetch('/api/check-session?t=' + new Date().getTime(), { 
        credentials: 'same-origin',
        headers: { 'Cache-Control': 'no-cache' }
      })
      .then(response => response.json())
      .then(data => {
        if (!data.authenticated) {
          // Session is invalid, redirect to login
          console.log('Session invalid, redirecting to login');
          localStorage.removeItem('isLoggedIn');
          window.location.href = '/login?expired=true&redirect=' + encodeURIComponent(window.location.pathname);
        }
      })
      .catch(error => {
        console.error('Session check error:', error);
      });
    }
    
    // Verify session on page load
    verifySession();
    
    // Also verify when page is shown (e.g., when returning via back button)
    window.addEventListener('pageshow', function(event) {
      // If page is loaded from cache (back/forward navigation)
      if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        verifySession();
      }
    });
    
    collapsibles.forEach(function(button) {
      button.addEventListener('click', function() {
        this.classList.toggle('active');
        
        // Toggle the display of the next element (the content)
        const content = this.nextElementSibling;
        if (content.style.display === 'block') {
          content.style.display = 'none';
        } else {
          content.style.display = 'block';
        }
      });
      
      // Auto-expand the first section
      if (button === collapsibles[0]) {
        button.classList.add('active');
        const content = button.nextElementSibling;
        content.style.display = 'block';
      }
    });

    // Dynamic search functionality
    const searchInput = document.getElementById('searchInput');
    const noPostsMessage = document.getElementById('noPostsMessage');
    const searchTerm = document.getElementById('searchTerm');
    const yearSections = document.querySelectorAll('.year-section');
    const postCards = document.querySelectorAll('.post-card');
    
    searchInput.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      let totalMatchingPosts = 0;
      searchTerm.textContent = query;
      
      // Reset display of all sections
      yearSections.forEach(section => {
        section.style.display = 'block';
        let yearMatchCount = 0;
        
        // Get all post cards within this year section
        const yearPosts = section.querySelectorAll('.post-card');
        
        yearPosts.forEach(post => {
          const title = post.getAttribute('data-title');
          const author = post.getAttribute('data-author');
          const content = post.querySelector('.post-card-content p').textContent.toLowerCase();
          
          if (query === '' || 
              title.includes(query) || 
              author.includes(query) || 
              content.includes(query)) {
            post.style.display = 'block';
            yearMatchCount++;
            totalMatchingPosts++;
          } else {
            post.style.display = 'none';
          }
        });
        
        // Hide year section if no posts match
        if (yearMatchCount === 0) {
          section.style.display = 'none';
        } else {
          // Make sure content is visible if there are matches
          const content = section.querySelector('.content');
          const button = section.querySelector('.collapsible');
          content.style.display = 'block';
          button.classList.add('active');
        }
      });
      
      // Show "no posts" message if no matches
      if (totalMatchingPosts === 0 && query !== '') {
        noPostsMessage.style.display = 'block';
      } else {
        noPostsMessage.style.display = 'none';
      }
    });
  });
</script>
</body>

</html>
